<div class="card bg-transparent p-5 w-full max-w-6xl mx-auto">

    <!-- Trigger Button -->
    <button class="btn w-64 btn-sm btn-outline mb-5" onclick="add_unit_modal.showModal()">Einheit hinzufügen</button>

    <!-- Add Unit Modal -->
    <dialog id="add_unit_modal" class="modal">
        <div class="modal-box bg-base-100 text-base-content">
            <form method="post" action="{% url 'add_unit' %}">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="add_unit_modal.close()">✕</button>
                <h1 class="text-lg font-bold mb-4">Einheit hinzufügen</h1>
                <div class="mb-4 hidden">
                    <label class="label">
                        <span class="label-text">Gebäude</span>
                    </label>
                    <input type="hidden" name="property" value="{{ property.id }}" />
                    <input type="text" class="input input-bordered w-full" value="{{ property.name }}" disabled />
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Einheitenname</span>
                    </label>
                    <input type="text" name="unit_name" class="input input-bordered w-full" required>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Fläche (m²)</span>
                    </label>
                    <input type="number" name="floor_area" step="0.1" class="input input-bordered w-full" required>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Etage</span>
                    </label>
                    <input type="number" name="floor" class="input input-bordered w-full" required>
                </div>

                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Miete</span>
                    </label>
                    <input type="number" name="rent" step="0.01" class="input input-bordered w-full" required>
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">NebenKosten</span>
                    </label>
                    <input type="number" name="additional_costs" step="0.01" class="input input-bordered w-full">
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Stellplatz Miete</span>
                    </label>
                    <input type="number" name="stellplatz_miete" class="input input-bordered w-full">
                </div>
                <div class="mb-4">
                    <label class="label">
                        <span class="label-text">Investitionmiete</span>
                    </label>
                    <input type="number" name="investition_miete" class="input input-bordered w-full">
                </div>
                

                <div class="modal-action">
                    <button type="submit" class="btn btn-outline">Hinzufügen</button>
                    <button type="button" class="btn btn-outline btn-error" onclick="add_unit_modal.close()">Abbrechen</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- Unit List -->
    <div class="overflow-x-auto h-96 mb-10">
        <h2 class="text-xl font-light mb-3">Units for {{ property.name }}</h2>
        <div class="mb-4 flex items-center gap-2">
            <select id="tenantFilterUnit" multiple class="w-64" placeholder="Mieter auswählen...">
              {% for tenant in tenants %}
                <option value="{{ tenant.name }}">{{ tenant.name }}</option>
              {% endfor %}
            </select>
          </div>
          
        
        <table id="unitTable" class="table text-left bg-base-100 text-base-content">

            <thead>
                <tr class="border-b border-base-200">
                    <th>Einheitenname</th>
                    <th>Mieter</th> 
                    <th>Fläche</th>
                    <th>Etage</th>
                    <!-- <th>Position</th> -->
                    <th>Miete</th>
                    <th>NebenKosten</th>
                    <th>Stellplatz Miete</th>
                    <th>Investitionmiete</th>
                    <th>Aktionen</th>
                </tr>
            </thead>            
            
            <tbody>
                {% for unit in units %}
                <tr>
                    <td>
                        <a href="#" class="font-semibold hover:text-primary hover:underline transition-all"
                        onclick="openunitEditModal(
                            {{ unit.id }}, 
                            '{{ unit.unit_name|escapejs }}', 
                            '{{ unit.floor_area|default:0|floatformat:"1" }}', 
                            {{ unit.floor|default:0 }}, 
                            '{{ unit.position|default:''|escapejs }}', 
                            '{{ unit.rent|default:0|floatformat:"2" }}', 
                            '{{ unit.additional_costs|default:0|floatformat:"2" }}',
                            '{{ unit.stellplatz_miete|default:0|floatformat:"2" }}',
                            '{{ unit.investition_miete|default:0|floatformat:"2" }}'
                        )"
            
                        >
                            {{ unit.unit_name }}
                        </a>
                    </td>
                    <td>
                        {% with unit.leases.first as lease %}
                            {% if lease and lease.tenants.all %}
                                {% for tenant in lease.tenants.all %}
                                    {{ tenant.name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                <span class="text-gray-500">Kein Mieter</span>
                            {% endif %}
                        {% endwith %}
                    </td>
                    
                    <td>{{ unit.floor_area|floatformat:"1" }} sq.m.</td>
                    <td>{{ unit.floor }}</td>
                    <!-- <td>
                        {% if unit.position == "Left" %} Links
                        {% elif unit.position == "Middle" %} Mitte
                        {% elif unit.position == "Right" %} Rechts
                        {% else %} - {% endif %}
                    </td>
                     -->
                    <td>€{{ unit.rent|floatformat:"2" }}</td>
                    <td>€{{ unit.additional_costs|default:0|floatformat:"2" }}</td>
                    <td>€{{ unit.stellplatz_miete|default:0|floatformat:"2" }}</td>
                    <td>€{{ unit.investition_miete|default:0|floatformat:"2" }}</td>

                    
                    <td>
                        <!-- Delete Form with Circular Button -->
                        <form method="post" action="{% url 'delete_unit' unit.id %}" class="inline"
                            onsubmit="return confirm('Are you sure you want to delete this unit?');">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="btn btn-circle btn-outline btn-error btn-sm hover:bg-error hover:text-white hover:border-transparent transition-all" 
                                    aria-label="Delete Unit">
                                ✕
                            </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center text-base-content/50">Keine Einheiten verfügbar.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function openunitEditModal(id, unitName, floorArea, floor, position, rent, additionalCosts , stellplatzMiete, investitionMiete) {
    console.log(id, unitName, floorArea, floor, position, rent, additionalCosts);
    document.getElementById('edit_unit_form').action = `/edit_unit/${id}/`;
    document.getElementById('edit_unit_name').value = unitName;
    document.getElementById('edit_floor_area').value = floorArea ? parseFloat(floorArea).toFixed(1) : '';
    document.getElementById('edit_floor').value = floor ? parseInt(floor, 10) : '';
    // document.getElementById('edit_position').value = position;
    document.getElementById('edit_rent').value = rent
        ? parseFloat(rent.replace(/\./g, '').replace(',', '.')).toFixed(2)
        : '';

    document.getElementById('edit_additional_costs').value = additionalCosts
        ? parseFloat(additionalCosts.replace(/\./g, '').replace(',', '.')).toFixed(2)
        : '';
    document.getElementById('edit_stellplatz_miete').value = stellplatzMiete
        ? parseFloat(stellplatzMiete.replace(/\./g, '').replace(',', '.')).toFixed(2)
        : '';
    document.getElementById('edit_investition_miete').value = investitionMiete
        ? parseFloat(investitionMiete.replace(/\./g, '').replace(',', '.')).toFixed(2)
        : '';
    document.getElementById('edit_unit_modal').showModal();
}

</script>

<script>
function filterUnitsByTenant() {
    const selectedTenant = document.getElementById("tenantFilterUnit").value.toLowerCase().trim();
    const tableRows = document.querySelectorAll("#unitTable tbody tr");

    tableRows.forEach(row => {
        const tenantColumn = row.querySelector("td:nth-child(2)"); // Adjust index if needed
        if (tenantColumn) {
            const tenantNames = tenantColumn.innerText.toLowerCase().trim().split(", "); // Handles multiple tenants
            row.style.display = selectedTenant === "" || tenantNames.includes(selectedTenant) ? "" : "none";
        }
    });
}

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      const tenantSelect = new TomSelect("#tenantFilterUnit", {
        plugins: ['remove_button'],
        placeholder: 'Mieter auswählen...',
        persist: false,
        maxItems: null,
        onChange: function (values) {
          filterUnitsByTenant(values);
        }
      });
    });
    </script>