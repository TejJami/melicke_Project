{% extends 'bookkeeping/base.html' %}

{% block title %}Mieter{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">Mieter</h1>
        <div class="flex items-center gap-3">
            <button
              aria-label="Search button"
              onclick="search_modal.showModal()"
              class="btn btn-outline btn-sm h-9 w-48 items-center justify-start gap-3 border-base-content/20 hover:border-transparent hover:bg-base-content/20">
              <iconify-icon icon="lucide:search" height="16" class="text-base-content/60"></iconify-icon>
              <span class="text-base-content/60">
                  {% if request.GET.q %}
                  Suche nach"{{ request.GET.q }}"
                  {% else %}
                  Suche
                  {% endif %}
              </span>
            </button>
            <button class="btn btn-glass btn-outline btn-sm" onclick="add_tenant_modal.showModal()">+ Mieter hinzufügen</button>
        </div>
</div>

<!-- Search Modal -->
<dialog aria-label="Modal" class="modal" id="search_modal">
        <div class="modal-box p-0">
            <form method="get" action="{% url 'tenants' %}">
                <div class="form-control flex-row items-center rounded-box p-2 px-5">
                    <iconify-icon icon="lucide:search" height="18" class="text-base-content/70"></iconify-icon>
                    <input
                    name="q"
                    placeholder="Mieter suchen"
                    value="{{ request.GET.q|default:'' }}"
                    class="input input-sm w-full text-base focus:border-transparent focus:outline-0 focus:outline-offset-0" />
                    
                   {% if request.GET.q %}
                   <a href="{% url 'tenants' %}" class="btn btn-circle btn-ghost btn-sm gap-2">
                       <iconify-icon icon="lucide:x" height="16"></iconify-icon>
                   </a>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-circle btn-ghost btn-sm gap-2">
                        <iconify-icon icon="lucide:search" height="16"></iconify-icon>
                    </button>
                </div>
            </form>
        </div>
</dialog>

<!-- Add Tenant Modal -->
<dialog id="add_tenant_modal" class="modal">
        <div class="modal-box bg-base-100 text-base-content">
            <form method="post" action="{% url 'add_tenant' %}">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="add_tenant_modal.close()">✕</button>
                <h1 class="text-lg font-bold mb-4">Mieter hinzufügen</h1>
                
                <!-- Name -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Name *</span> </label>
                    <input type="text" name="name" class="input input-bordered w-full" placeholder="Tenant Name" required>
                </div>

                <!-- Other Account Names -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Andere Kontonamen</span> </label>
                    <input type="text" name="other_account_names" class="input input-bordered w-full" placeholder="Other Account Names">
                </div>

                <!-- Phone Number -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Telefonnummer</span> </label>
                    <input type="text" name="phone_number" class="input input-bordered w-full" placeholder="Phone Number">
                </div>

                <!-- Email -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Email</span> </label>
                    <input type="email" name="email" class="input input-bordered w-full" placeholder="Email">
                </div>

                <!-- Address -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Adresse</span> </label>
                    <textarea name="address" class="textarea textarea-bordered w-full" placeholder="Address"></textarea>
                </div>

                <!-- IBAN -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">IBAN</span> </label>
                    <input type="text" name="iban" class="input input-bordered w-full" placeholder="IBAN">
                </div>

                <!-- BIC -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">BIC</span> </label>
                    <input type="text" name="bic" class="input input-bordered w-full" placeholder="BIC">
                </div>

                <!-- Notes -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Notizen</span> </label>
                    <textarea name="notes" class="textarea textarea-bordered w-full" placeholder="Additional Notes"></textarea>
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-outline">Hinzufügen</button>
                    <button type="button" class="btn btn-outline btn-error" onclick="add_tenant_modal.close()">Abbrechen</button>
                </div>
            </form>
        </div>
</dialog>

<!-- Toggle Button -->
<div class="flex justify-end mb-3">
    <label class="flex items-center gap-2 cursor-pointer">
        <input type="checkbox" id="toggleLeaseDetails" class="checkbox">
        <span>Lease Details Anzeigen</span>
    </label>
</div>

<!-- Tenant Table -->
<div class="overflow-x-auto">
    <table class="table w-full text-left bg-base-100 text-base-content">
        <thead>
            <tr id="tenantTableHeaders">
                <th>Name</th>
                <th>Unit</th>
                <th class="lease-toggle">Andere Kontonamen</th>
                <th class="lease-toggle">Property Type</th>
                <th>Telefon</th>
                <th>Email</th>
                <th>Adresse</th>
                <th class="lease-details hidden">Start Date</th>
                <th class="lease-details hidden">End Date</th>
                <th class="lease-details hidden">Rent</th>
                <th class="lease-details hidden">Deposit</th>
                <th class="lease-details hidden">USt Type</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for tenant in tenants %}
            <tr>
                <td><strong>{{ tenant.name }}</strong></td>
                <td>
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>{{ lease.unit.unit_name }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">Kein Mietvertrag</span>
                    {% endif %}
                </td>

                <td class="lease-toggle">
                    {{ tenant.other_account_names }}
                </td>

                <td class="lease-toggle">
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>{{ lease.property.property_type }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>

                <td>{{ tenant.phone_number }}</td>
                <td>{{ tenant.email }}</td>
                <td>{{ tenant.address }}</td>

                <!-- Lease Details (Hidden by Default) -->
                <td class="lease-details hidden">
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>{{ lease.start_date|default:"-" }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>

                <td class="lease-details hidden">
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>{{ lease.end_date|default:"-" }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>

                <td class="lease-details hidden">
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>€{{ lease.rent|floatformat:2 }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>

                <td class="lease-details hidden">
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>€{{ lease.deposit_amount|floatformat:2 }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>

                <td class="lease-details hidden">
                    {% if tenant.leases.all %}
                        {% for lease in tenant.leases.all %}
                            <span>{{ lease.ust_type }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-gray-500">-</span>
                    {% endif %}
                </td>

                <td>
                    <form method="post" action="{% url 'delete_tenant' tenant.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this tenant?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-circle btn-outline btn-error btn-sm">✕</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
document.getElementById("toggleLeaseDetails").addEventListener("change", function () {
    let leaseDetails = document.querySelectorAll(".lease-details");
    let leaseHeaders = document.querySelectorAll(".lease-details");
    let leaseToggleCols = document.querySelectorAll(".lease-toggle");

    if (this.checked) {
        leaseDetails.forEach(col => col.classList.remove("hidden"));
        leaseHeaders.forEach(header => header.classList.remove("hidden"));
        leaseToggleCols.forEach(col => col.classList.add("hidden")); // Hide "Other Account Names" and "Property Type"
    } else {
        leaseDetails.forEach(col => col.classList.add("hidden"));
        leaseHeaders.forEach(header => header.classList.add("hidden"));
        leaseToggleCols.forEach(col => col.classList.remove("hidden"));
    }
});
</script>

    

<dialog id="delete_tenant_modal" class="modal">
    <div class="modal-box bg-base-100 text-base-content">
        <form method="post" id="delete_tenant_form">
            {% csrf_token %}
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="delete_tenant_modal.close()">✕</button>
            <h1 class="text-lg font-bold mb-4 text-error">Mieter löschen</h1>
            <p class="mb-4 text-base-content">
                Bist du sicher, dass du <strong id="delete_tenant_name"></strong> löschen möchtest? 
                Bitte gib den Namen ein, um fortzufahren.
            </p>

            <!-- Input for confirming name -->
            <input type="text" id="confirm_tenant_name" class="input input-bordered w-full mb-4" placeholder="Mietername eingeben" required>

            <div class="modal-action">
                <button type="submit" id="confirm_delete_btn" class="btn btn-error" disabled>Löschen</button>
                <button type="button" class="btn btn-outline" onclick="delete_tenant_modal.close()">Abbrechen</button>
            </div>
        </form>
    </div>
</dialog>


<!-- Edit Tenant Modal -->
<dialog id="edit_tenant_modal" class="modal">
    <div class="modal-box bg-base-100 text-base-content">
        <form method="post" id="edit_tenant_form">
            {% csrf_token %}
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="edit_tenant_modal.close()">✕</button>
            <h1 class="text-lg font-bold mb-4">Edit Tenant</h1>
            
            <!-- Form Fields for Editing Tenant -->
            <input type="hidden" name="tenant_id" id="edit_tenant_id">
            <label>Name *</label>
            <input type="text" name="name" id="edit_tenant_name" class="input input-bordered w-full mb-2" required>

            <label>Andere Kontonamen</label>
            <input type="text" name="other_account_names" id="edit_other_account_names" class="input input-bordered w-full mb-2">

            <label>Telefon</label>
            <input type="text" name="phone_number" id="edit_phone_number" class="input input-bordered w-full mb-2">

            <label>Email</label>
            <input type="email" name="email" id="edit_email" class="input input-bordered w-full mb-2">

            <label>Adresse</label>
            <textarea name="address" id="edit_address" class="textarea textarea-bordered w-full mb-2"></textarea>

            <label>IBAN</label>
            <input type="text" name="iban" id="edit_iban" class="input input-bordered w-full mb-2">

            <label>BIC</label>
            <input type="text" name="bic" id="edit_bic" class="input input-bordered w-full mb-2">

            <label>Notizen</label>
            <textarea name="notes" id="edit_notes" class="textarea textarea-bordered w-full mb-2"></textarea>

            <div class="modal-action">
                <button type="submit" class="btn btn-outline">Speichern</button>
                <button type="button" class="btn btn-outline btn-error" onclick="edit_tenant_modal.close()">Abbrechen</button>
            </div>
        </form>
    </div>
</dialog>

<script>
function openEditTenantModal(id, name, otherAccountNames, phoneNumber, email, address, iban, bic, notes) {
    const form = document.getElementById('edit_tenant_form');
    form.action = `/edit_tenant/${id}/`;

    document.getElementById('edit_tenant_id').value = id;
    document.getElementById('edit_tenant_name').value = name;
    document.getElementById('edit_other_account_names').value = otherAccountNames;
    document.getElementById('edit_phone_number').value = phoneNumber;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_address').value = address;
    document.getElementById('edit_iban').value = iban;
    document.getElementById('edit_bic').value = bic;
    document.getElementById('edit_notes').value = notes;

    edit_tenant_modal.showModal();
}

function openDeleteTenantModal(tenantId, tenantName) {
    const form = document.getElementById('delete_tenant_form');
    form.action = `/delete_tenant/${tenantId}/`;  // Set correct URL

    // Set tenant name in modal
    document.getElementById('delete_tenant_name').innerText = tenantName;
    const confirmInput = document.getElementById('confirm_tenant_name');
    const confirmBtn = document.getElementById('confirm_delete_btn');

    // Reset input and disable button
    confirmInput.value = '';
    confirmBtn.disabled = true;

    // Enable button only if name matches
    confirmInput.addEventListener('input', function () {
        confirmBtn.disabled = this.value !== tenantName;
    });

    // Show the modal
    delete_tenant_modal.showModal();
}

</script>
<script>
    function showLeaseDetails(event, property, unit, start, end, rent, deposit, ust) {
        let tooltip = document.getElementById("lease-tooltip");
        
        // Set the tooltip content
        tooltip.innerHTML = `
            <strong>Property:</strong> ${property} <br>
            <strong>Unit:</strong> ${unit} <br>
            <strong>Start Date:</strong> ${start} <br>
            <strong>End Date:</strong> ${end} <br>
            <strong>Rent:</strong> €${rent} <br>
            <strong>Deposit:</strong> €${deposit} <br>
            <strong>USt Type:</strong> ${ust}
        `;

        // Adjust position
        tooltip.style.display = "block";
        tooltip.style.left = event.pageX + 15 + "px";
        tooltip.style.top = event.pageY + "px";

        // Update tooltip theme dynamically
        updateTooltipTheme();
    }

    function hideLeaseDetails() {
        document.getElementById("lease-tooltip").style.display = "none";
    }

    function updateTooltipTheme() {
        let tooltip = document.getElementById("lease-tooltip");
        let htmlElement = document.documentElement;
        let theme = htmlElement.getAttribute("data-theme");

        if (theme === "light") {
            tooltip.classList.remove("bg-gray-800", "text-white");
            tooltip.classList.add("bg-gray-200", "text-black");
        } else {
            tooltip.classList.remove("bg-gray-200", "text-black");
            tooltip.classList.add("bg-gray-800", "text-white");
        }
    }

    // Listen for theme changes
    document.addEventListener("custom.layout-changed", updateTooltipTheme);
</script>

<!-- Tooltip Box -->
<div id="lease-tooltip" class="fixed hidden bg-gray-800 text-white text-xs p-2 rounded-lg shadow-md z-50"></div>

{% endblock %}
