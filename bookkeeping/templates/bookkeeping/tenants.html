{% extends 'bookkeeping/base.html' %}

{% block title %}Mieter{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">Mieter</h1>
        <div class="flex items-center gap-3">
            <button
              aria-label="Search button"
              onclick="search_modal.showModal()"
              class="btn btn-outline btn-sm h-9 w-48 items-center justify-start gap-3 border-base-content/20 hover:border-transparent hover:bg-base-content/20">
              <iconify-icon icon="lucide:search" height="16" class="text-base-content/60"></iconify-icon>
              <span class="text-base-content/60">
                  {% if request.GET.q %}
                  Suche nach"{{ request.GET.q }}"
                  {% else %}
                  Suche
                  {% endif %}
              </span>
            </button>
            <button class="btn btn-glass btn-outline btn-sm" onclick="add_tenant_modal.showModal()">+ Mieter hinzufügen</button>
        </div>
</div>

<!-- Search Modal -->
<dialog aria-label="Modal" class="modal" id="search_modal">
        <div class="modal-box p-0">
            <form method="get" action="{% url 'tenants' %}">
                <div class="form-control flex-row items-center rounded-box p-2 px-5">
                    <iconify-icon icon="lucide:search" height="18" class="text-base-content/70"></iconify-icon>
                    <input
                    name="q"
                    placeholder="Mieter suchen"
                    value="{{ request.GET.q|default:'' }}"
                    class="input input-sm w-full text-base focus:border-transparent focus:outline-0 focus:outline-offset-0" />
                    
                   {% if request.GET.q %}
                   <a href="{% url 'tenants' %}" class="btn btn-circle btn-ghost btn-sm gap-2">
                       <iconify-icon icon="lucide:x" height="16"></iconify-icon>
                   </a>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-circle btn-ghost btn-sm gap-2">
                        <iconify-icon icon="lucide:search" height="16"></iconify-icon>
                    </button>
                </div>
            </form>
        </div>
</dialog>

<!-- Add Tenant Modal -->
<dialog id="add_tenant_modal" class="modal">
        <div class="modal-box bg-base-100 text-base-content">
            <form method="post" action="{% url 'add_tenant' %}">
                {% csrf_token %}
                <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="add_tenant_modal.close()">✕</button>
                <h1 class="text-lg font-bold mb-4">Mieter hinzufügen</h1>
                
                <!-- Name -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Name *</span> </label>
                    <input type="text" name="name" class="input input-bordered w-full" placeholder="Tenant Name" required>
                </div>

                <!-- Other Account Names -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Andere Kontonamen</span> </label>
                    <input type="text" name="other_account_names" class="input input-bordered w-full" placeholder="Other Account Names">
                </div>

                <!-- Phone Number -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Telefonnummer</span> </label>
                    <input type="text" name="phone_number" class="input input-bordered w-full" placeholder="Phone Number">
                </div>

                <!-- Email -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Email</span> </label>
                    <input type="email" name="email" class="input input-bordered w-full" placeholder="Email">
                </div>

                <!-- Address -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Adresse</span> </label>
                    <textarea name="address" class="textarea textarea-bordered w-full" placeholder="Address"></textarea>
                </div>

                <!-- IBAN -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">IBAN</span> </label>
                    <input type="text" name="iban" class="input input-bordered w-full" placeholder="IBAN">
                </div>

                <!-- BIC -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">BIC</span> </label>
                    <input type="text" name="bic" class="input input-bordered w-full" placeholder="BIC">
                </div>

                <!-- Notes -->
                <div class="mb-4">
                    <label class="label"> <span class="label-text">Notizen</span> </label>
                    <textarea name="notes" class="textarea textarea-bordered w-full" placeholder="Additional Notes"></textarea>
                </div>

                <div class="modal-action">
                    <button type="submit" class="btn btn-outline">Hinzufügen</button>
                    <button type="button" class="btn btn-outline btn-error" onclick="add_tenant_modal.close()">Abbrechen</button>
                </div>
            </form>
        </div>
</dialog>

<!-- Toggle Button with DaisyUI -->
<div class="flex justify-end mb-3">
    <label class="flex items-center gap-2 cursor-pointer">
        <input type="checkbox" id="toggleLeaseDetails" class="toggle toggle-primary">
        <span class="font-semibold">Sollstellung</span>
    </label>
</div>


<!-- Tenant Table -->
<div class="overflow-x-auto">
    <form method="get" class="flex items-center gap-4 mb-4">

        <select name="property" class="select select-bordered">
          <option value="">Alle Objekte</option>
          {% for prop in properties %}
            <option value="{{ prop.id }}" {% if prop.id|stringformat:"s" == selected_property_id %}selected{% endif %}>
              {{ prop.name }}
            </option>
          {% endfor %}
        </select>
      
        <button class="btn btn-sm btn-outline" type="submit">Filtern</button>
      </form>
      
    <table class="table w-full text-left bg-base-100 text-base-content">
        <thead>
            <tr>
                <th>Name</th>
                <th class="lease-columns hidden">Gesamtschuld</th>

                <th>Unit</th>

                
                <!-- Contact Columns (Hidden when Lease Details are Shown) -->
                <th class="contact-columns">Telefon</th>
                <th class="contact-columns">Email</th>
                <th class="contact-columns">Adresse</th>
        
                <!-- Lease Columns (Hidden by Default) -->
                <th class="lease-columns hidden">Startdatum</th>
                <th class="lease-columns hidden">Enddatum</th>
                <th class="lease-columns hidden">Miete</th>
                <th class="lease-columns hidden">NebenKosten</th>
                <th class="lease-columns hidden">Bürgschaft</th>
                <th class="lease-columns hidden">USt Typ</th>
        
                <th>Aktionen</th>
            </tr>
        </thead>
        
        <tbody>
            {% for tenant in tenants %}
                {% with leases=tenant.leases.all %}
                    {% if leases %}
                        {% for lease in leases %}
                            <tr>
                                {% if forloop.first %}
                                    <td rowspan="{{ leases|length }}">{{ tenant.name }}</td>
                                {% endif %}
                                {% if forloop.first %}
                                    <td rowspan="{{ leases|length }}" class="lease-columns" style="display: none;">
                                        {% if tenant.total_monthly_debt %}
                                            €{{ tenant.total_monthly_debt|floatformat:2 }}
                                        {% else %}
                                            –
                                        {% endif %}
                                    </td>
                                {% endif %}

                                <td>{{ lease.unit.unit_name }}</td>
            
                                <!-- Contact Columns -->
                                <td class="contact-columns">{{ tenant.phone_number }}</td>
                                <td class="contact-columns">{{ tenant.email }}</td>
                                <td class="contact-columns">{{ tenant.address }}</td>
            
                                <!-- Lease Columns -->
                                <td class="lease-columns" style="display: none;">{{ lease.start_date|default:"-" }}</td>
                                <td class="lease-columns" style="display: none;">{{ lease.end_date|default:"-" }}</td>
                                <td class="lease-columns" style="display: none;">€{{ lease.rent|floatformat:2 }}</td>
                                <td class="lease-columns" style="display: none;">€{{ lease.additional_costs|floatformat:2 }}</td>
                                <td class="lease-columns" style="display: none;">€{{ lease.deposit_amount|floatformat:2 }}</td>
                                <td class="lease-columns" style="display: none;">{{ lease.ust_type }}</td>
            
                                {% if forloop.first %}
                                    <td rowspan="{{ leases|length }}">
                                        <button 
                                            class="btn btn-circle btn-outline btn-warning btn-sm mr-2" 
                                            onclick="openEditTenantModal(
                                                '{{ tenant.id }}', 
                                                '{{ tenant.name|escapejs }}', 
                                                '{{ tenant.other_account_names|default:''|escapejs }}', 
                                                '{{ tenant.phone_number|default:''|escapejs }}', 
                                                '{{ tenant.email|default:''|escapejs }}', 
                                                '{{ tenant.address|default:''|escapejs }}', 
                                                '{{ tenant.iban|default:''|escapejs }}', 
                                                '{{ tenant.bic|default:''|escapejs }}', 
                                                '{{ tenant.notes|default:''|escapejs }}'
                                            )">
                                            ✏️
                                        </button>
                                        <button 
                                            class="btn btn-circle btn-outline btn-error btn-sm hover:bg-error hover:text-white" 
                                            onclick="openDeleteTenantModal('{{ tenant.id }}', '{{ tenant.name|escapejs }}')">
                                            ✕
                                        </button>
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td>{{ tenant.name }}</td>
                            <td><span class="text-gray-500">Kein Mietvertrag</span></td>
            
                            <!-- Contact Columns -->
                            <td class="contact-columns">{{ tenant.phone_number }}</td>
                            <td class="contact-columns">{{ tenant.email }}</td>
                            <td class="contact-columns">{{ tenant.address }}</td>

                            <td class="lease-columns" style="display: none;">-</td>
                            <td class="lease-columns" style="display: none;">-</td>
                            <td class="lease-columns" style="display: none;">-</td>
                            <td class="lease-columns" style="display: none;">-</td>
                            <td class="lease-columns" style="display: none;">-</td>
                            <td class="lease-columns" style="display: none;">-</td>

            
                            <!-- Actions -->
                            <td>
                                <button 
                                    class="btn btn-circle btn-outline btn-warning btn-sm mr-2" 
                                    onclick="openEditTenantModal(
                                        '{{ tenant.id }}', 
                                        '{{ tenant.name|escapejs }}', 
                                        '{{ tenant.other_account_names|default:''|escapejs }}', 
                                        '{{ tenant.phone_number|default:''|escapejs }}', 
                                        '{{ tenant.email|default:''|escapejs }}', 
                                        '{{ tenant.address|default:''|escapejs }}', 
                                        '{{ tenant.iban|default:''|escapejs }}', 
                                        '{{ tenant.bic|default:''|escapejs }}', 
                                        '{{ tenant.notes|default:''|escapejs }}'
                                    )">
                                    ✏️
                                </button>
                                <button 
                                    class="btn btn-circle btn-outline btn-error btn-sm hover:bg-error hover:text-white" 
                                    onclick="openDeleteTenantModal('{{ tenant.id }}', '{{ tenant.name|escapejs }}')">
                                    ✕
                                </button>
                            </td>
                        </tr>
                    {% endif %}
                {% endwith %}
            {% endfor %}
            </tbody>
            
        
        
    </table>
</div>



<!-- Toggle Functionality -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("toggleLeaseDetails");

    toggle.addEventListener("change", function () {
        const showDetails = this.checked;

        // Hide/Show the lease-specific columns
        document.querySelectorAll(".lease-columns").forEach(col => {
            col.style.display = showDetails ? "table-cell" : "none";
        });

        // Hide/Show the general contact columns
        document.querySelectorAll(".contact-columns").forEach(col => {
            col.style.display = showDetails ? "none" : "table-cell";
        });
    });
});

</script>

    

<dialog id="delete_tenant_modal" class="modal">
    <div class="modal-box bg-base-100 text-base-content">
        <form method="post" id="delete_tenant_form">
            {% csrf_token %}
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="delete_tenant_modal.close()">✕</button>
            <h1 class="text-lg font-bold mb-4 text-error">Mieter löschen</h1>
            <p class="mb-4 text-base-content">
                Bist du sicher, dass du <strong id="delete_tenant_name"></strong> löschen möchtest? 
                Bitte gib den Namen ein, um fortzufahren.
            </p>

            <!-- Input for confirming name -->
            <input type="text" id="confirm_tenant_name" class="input input-bordered w-full mb-4" placeholder="Mietername eingeben" required>

            <div class="modal-action">
                <button type="submit" id="confirm_delete_btn" class="btn btn-error" disabled>Löschen</button>
                <button type="button" class="btn btn-outline" onclick="delete_tenant_modal.close()">Abbrechen</button>
            </div>
        </form>
    </div>
</dialog>


<!-- Edit Tenant Modal -->
<dialog id="edit_tenant_modal" class="modal">
    <div class="modal-box bg-base-100 text-base-content">
        <form method="post" id="edit_tenant_form">
            {% csrf_token %}
            <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" onclick="edit_tenant_modal.close()">✕</button>
            <h1 class="text-lg font-bold mb-4">Edit Tenant</h1>
            
            <!-- Form Fields for Editing Tenant -->
            <input type="hidden" name="tenant_id" id="edit_tenant_id">
            <label>Name *</label>
            <input type="text" name="name" id="edit_tenant_name" class="input input-bordered w-full mb-2" required>

            <label>Andere Kontonamen</label>
            <input type="text" name="other_account_names" id="edit_other_account_names" class="input input-bordered w-full mb-2">

            <label>Telefon</label>
            <input type="text" name="phone_number" id="edit_phone_number" class="input input-bordered w-full mb-2">

            <label>Email</label>
            <input type="email" name="email" id="edit_email" class="input input-bordered w-full mb-2">

            <label>Adresse</label>
            <textarea name="address" id="edit_address" class="textarea textarea-bordered w-full mb-2"></textarea>

            <label>IBAN</label>
            <input type="text" name="iban" id="edit_iban" class="input input-bordered w-full mb-2">

            <label>BIC</label>
            <input type="text" name="bic" id="edit_bic" class="input input-bordered w-full mb-2">

            <label>Notizen</label>
            <textarea name="notes" id="edit_notes" class="textarea textarea-bordered w-full mb-2"></textarea>

            <div class="modal-action">
                <button type="submit" class="btn btn-outline">Speichern</button>
                <button type="button" class="btn btn-outline btn-error" onclick="edit_tenant_modal.close()">Abbrechen</button>
            </div>
        </form>
    </div>
</dialog>

<script>
function openEditTenantModal(id, name, otherAccountNames, phoneNumber, email, address, iban, bic, notes) {
    const form = document.getElementById('edit_tenant_form');
    form.action = `/edit_tenant/${id}/`;

    document.getElementById('edit_tenant_id').value = id;
    document.getElementById('edit_tenant_name').value = name;
    document.getElementById('edit_other_account_names').value = otherAccountNames;
    document.getElementById('edit_phone_number').value = phoneNumber;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_address').value = address;
    document.getElementById('edit_iban').value = iban;
    document.getElementById('edit_bic').value = bic;
    document.getElementById('edit_notes').value = notes;

    edit_tenant_modal.showModal();
}

function openDeleteTenantModal(tenantId, tenantName) {
    const form = document.getElementById('delete_tenant_form');
    form.action = `/delete_tenant/${tenantId}/`;  // Set correct URL

    // Set tenant name in modal
    document.getElementById('delete_tenant_name').innerText = tenantName;
    const confirmInput = document.getElementById('confirm_tenant_name');
    const confirmBtn = document.getElementById('confirm_delete_btn');

    // Reset input and disable button
    confirmInput.value = '';
    confirmBtn.disabled = true;

    // Enable button only if name matches
    confirmInput.addEventListener('input', function () {
        confirmBtn.disabled = this.value !== tenantName;
    });

    // Show the modal
    delete_tenant_modal.showModal();
}

</script>
<script>
    function showLeaseDetails(event, property, unit, start, end, rent, deposit, ust) {
        let tooltip = document.getElementById("lease-tooltip");
        
        // Set the tooltip content
        tooltip.innerHTML = `
            <strong>Property:</strong> ${property} <br>
            <strong>Unit:</strong> ${unit} <br>
            <strong>Start Date:</strong> ${start} <br>
            <strong>End Date:</strong> ${end} <br>
            <strong>Rent:</strong> €${rent} <br>
            <strong>Deposit:</strong> €${deposit} <br>
            <strong>USt Type:</strong> ${ust}
        `;

        // Adjust position
        tooltip.style.display = "block";
        tooltip.style.left = event.pageX + 15 + "px";
        tooltip.style.top = event.pageY + "px";

        // Update tooltip theme dynamically
        updateTooltipTheme();
    }

    function hideLeaseDetails() {
        document.getElementById("lease-tooltip").style.display = "none";
    }

    function updateTooltipTheme() {
        let tooltip = document.getElementById("lease-tooltip");
        let htmlElement = document.documentElement;
        let theme = htmlElement.getAttribute("data-theme");

        if (theme === "light") {
            tooltip.classList.remove("bg-gray-800", "text-white");
            tooltip.classList.add("bg-gray-200", "text-black");
        } else {
            tooltip.classList.remove("bg-gray-200", "text-black");
            tooltip.classList.add("bg-gray-800", "text-white");
        }
    }

    // Listen for theme changes
    document.addEventListener("custom.layout-changed", updateTooltipTheme);
</script>

<!-- Tooltip Box -->
<div id="lease-tooltip" class="fixed hidden bg-gray-800 text-white text-xs p-2 rounded-lg shadow-md z-50"></div>

{% endblock %}
